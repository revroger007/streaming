
sudo apt update && sudo apt upgrade -y
sudo apt install tclsh pkg-config libssl-dev build-essential make cmake tcl openssl zlib1g-dev gcc perl net-tools nano ssh git zip unzip ffmpeg net-tools ufw apt-transport-https ca-certificates curl software-properties-common -y
sudo ufw --force reset

# Set default policies
sudo ufw default deny incoming
sudo ufw default allow outgoing

# Allow SSH
sudo ufw allow ssh

# Allow SRTLA ports - menggunakan port yang benar
sudo ufw allow 5000/udp comment 'SRTLA Input'
sudo ufw allow 1935/tcp comment 'RTMP Output'

sudo ufw allow 5001/udp comment 'SRT Output'
sudo ufw allow 5002/udp comment 'SRT Output'

# Allow HTTP/HTTPS for WebUI (versi 2)
sudo ufw allow 8080/tcp comment 'WebUI'
sudo ufw allow 9090/tcp comment 'Monitoring'

# Enable firewall
sudo ufw --force enable

# Check status
sudo ufw status verbose

#This will download and make the SRTLA server:

sudo git clone https://github.com/BELABOX/srtla.git
cd srtla
sudo make
cd ../

#This will install, configure, and make the SRT server:

sudo git clone https://github.com/BELABOX/srt.git
cd srt
sudo ./configure
sudo make

sudo tee /etc/systemd/system/srtla-rec.service > /dev/null << 'EOF'
[Unit]
Description=SRTLA Receiver (Belabox Input)
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/root/srtla
ExecStart=/root/srtla/srtla_rec 5000 127.0.0.1 5002
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

# Kemudian buat service dengan nama srt-rhei, untuk transmisi ke datarhei restreamer

sudo tee /etc/systemd/system/srt-rhei.service > /dev/null << 'EOF'
[Unit]
Description=SRT Transmitter to Restreamer
After=network.target
Requires=srtla-rec.service

[Service]
Type=simple
User=root
WorkingDirectory=/root/srt
ExecStart=/root/srt/srt-live-transmit -st:yes \
  "srt://127.0.0.1:5002?mode=listener&latency=2000" \
  "srt://127.0.0.1:6000?mode=caller"
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target

EOF

#
sudo systemctl daemon-reload
sudo systemctl enable srtla-rec
sudo systemctl enable srt-rhei
sudo systemctl start srtla-rec
sudo systemctl start srt-rhei
#sudo systemctl status srt-rhei

#pada datarhei, gunakan source : srt,
# network source : srt://:6000?mode=listener

#Install Docker

#Install all required dependency packages.
sudo apt install apt-transport-https ca-certificates curl software-properties-common -y

#Add the Docker GPG key to your server's keyring.
sudo mkdir -p /etc/apt/keyrings
sudo chmod 0755 /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc

#Add the latest Docker repository to your APT sources.
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

#Update the server package index.
sudo apt update

#Install Docker.
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin -y

#Manage the Docker System Service
#Enable the system service to start automatically at boot time.

sudo systemctl enable docker

#View the Docker service status and verify that it's running.

sudo systemctl is-active docker

#Buat file : /opt/restreamer/docker-compose.yml

# Buat direktori
mkdir -p /opt/restreamer

# Buat file docker-compose.yml
cat > /opt/restreamer/docker-compose.yml << 'EOF'
version: '3.8'

services:
  restreamer:
    image: datarhei/restreamer:latest
    container_name: restreamer
    restart: unless-stopped
    privileged: true
    volumes:
      - /opt/core/config:/core/config
      - /opt/core/data:/core/data
    ports:
      - "8080:8080"
      - "8181:8181"
      - "1935:1935"
      - "5001:5001"
      - "1936:1936"
      - "6000:6000/udp"
EOF

Kemudian jalankan : 
cd /opt/restreamer
docker compose up -d
